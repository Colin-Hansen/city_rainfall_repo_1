---
title: "City of Calgary Rainfall Data Analysis - Single Site Approach"

author: "Colin Hansen, M.Eng., P. Eng."

date: "XX-February-2021"



# following code is from stackoverflow - to allow for landscape stype pdf output
# https://stackoverflow.com/questions/25849814/rstudio-rmarkdown-both-portrait-and-landscape-layout-in-a-single-pdf/41945462#41945462

header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}

output:
  pdf_document: default
  classoption: landscape # does not seem to work (30-JAN-2021)
  html_notebook: default
  html_document:
    df_print: paged
  word_document: default
---

##Project Description

Digital data files from the City of Calgary precipitation monitoring network are 
available from 1988 to 2020. The data files contain 5-minute precipitation amounts,
in units of mm, based on either tipping bucket or weighing type gauges. 

The data exist as stand-alone .OUT (tab-separated) files, and there is normally 
one file per site, per year. There is no user interface into the dataset, apart
from the ability to download individual files from the City's Open Data Portal:

[link] (https://data.calgary.ca/Environment/Historical-Rainfall/d9kv-swk3)


This project uses R software to read and compile the precipitation data. 
Based on the compiled data for each site, various summary statistics and charts
are created. The results can be exported to HTML, Word, or PDF type files. 


##Project Details

**Data Source:** 5 minute rainfall data from City of Calgary Water Resources Z:Drive

**Raw Data Format:** YYYY/MM/DD	HH:MM	   0.0

**Rain Gauge Equipment:** (to follow)

**Number of Locations:** 46 sites


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(printr)
library(reshape2)
library(pander)


# added 12-DEC-2020
library(lubridate)
library(scales)
library(rio)
library(knitr)
library(tinytex)
library(tidyverse)
# note: tidyverse includes 'dplyr' package but not 'plyr'
library(ggnewscale)
library(kableExtra)
library(hydroTSM)
library(cowplot)
#library(plyr)

panderOptions('knitr.auto.asis', FALSE)

```



```{r compile-raw-data, eval = FALSE, include=FALSE}

# remove the previous rainfall_data result

rm(rainfall_data)

# create (if necessary) 'data_out' directory
if(dir.exists('data_out') == FALSE) dir.create('data_out')


  # read the site names
  site_names<-read.table('Site Names/Site_Names_and_Ground_Elevations.csv',sep=",",header=TRUE,stringsAsFactors = FALSE)
 
  # extract a vector of the site names
  site_names<-as.character(site_names$Site.Name)
  
  # shorten to first two 2 site names - testing / optional
  # site_names <- site_names[1:2]
  site_names <- site_names[1]
  

  # get the names of the raw data subfolders
  subfolder_names<-dir('data_in',full.names = TRUE)
 
  # shorten to first XX years of data - testing / optional
  subfolder_names <- subfolder_names[1:6]
  
  
  ## ## ## Start of nested loop ## ## ##
  
  # enter loop along the site names (e.g. 'S01', 'S02', etc.)  
  for (j in seq_along(site_names)) {
  
  # enter loop along the subfolder names (e.g. 1988, 1989, etc.)
  for (i in seq_along(subfolder_names)) {
  
  name<-site_names[j]
  
  # strip the site names from the raw file names in each subfolder
  
  temp_names<-strtrim(dir(subfolder_names[i]),3)
 
  # check to see if the 'name' passed to the function exists in the trimmed file names
  if(name %in% temp_names)  {
    
 
  # the name of the matched file
  file_match_char<-list.files(subfolder_names[i],pattern = name)
  #print(file_match_char)
  
  # the full path pf the matched file
  file_match_path<-file.path(subfolder_names[i],file_match_char)
  #print(file_match_path)
  
   # reference the full path and the input file name using file.path
  infile<-file_match_path
  
  # read raw rainfall data using 'read.table'
  #rainfall_data<-read.table(infile,sep="\t",header=FALSE,skip=3,stringsAsFactors = FALSE)
  
  # read raw rainfall data using 'read_tsv'
  rainfall_data<-read_tsv(infile,col_names = FALSE,trim_ws = TRUE,skip = 3)
  
  colnames(rainfall_data)<-c("Date","Hour.Minute.Seconds","Rainfall")
  
  # create a column of Site.Name data
  Site.Name<-rep(name,nrow(rainfall_data))
 
  # get the discrete date - time components
  Year<-year(rainfall_data$Date)
  Month<-month(rainfall_data$Date)
  Week<-week(rainfall_data$Date)
  Day<-mday(rainfall_data$Date)
  Hour<-hour(rainfall_data$Hour.Minute.Seconds)
  Minute<-minute(rainfall_data$Hour.Minute.Seconds)  
  DOY<-yday(rainfall_data$Date)
  # turned the following row off
  # Cumulative.Yearly.Rainfall<-cumsum(rainfall_data$Rainfall)
  
  # column bind the data and the date info
  temp_df<-cbind(Site.Name,rainfall_data,Year,Month,Week,Day,Hour,Minute,DOY)
 
  # use mutate to add Date-Time from components
  temp_df <- temp_df %>% mutate(Date.Time=make_datetime(Year,Month,Day,Hour,Minute))
  
  
  # create empty list, on first pass
  if(i == 1) raw_data_list<-list(NULL)
  
  # build a list of the raw data for each site (see Hadley book, page 319)
  raw_data_list[[i]] <- temp_df
 
  }   
    
  else {
    
    print ("No filename match in that subfolder")
  }  
    
    } # end of 'seq_along(subfolder_names)'
    
 
  # create a directory to save the .CSV files
  CSV_master_folder_5_min<-paste0('data_out',"/MASTER_CSV_5_min")
 
  # create (if necessary) 'data_out/MASTER_CSV_5_min' directory
  if(dir.exists(CSV_master_folder_5_min) == FALSE) dir.create(CSV_master_folder_5_min)
  
  # create a file name to save the files for each site
  CSV_file_name<-paste0(name,"_5_min.csv")
  CSV_outfile<-file.path(CSV_master_folder_5_min, CSV_file_name)
    
  # convert the 'raw_data_list' list to a dataframe using ldply from 'plyr' package
  raw_data_XX<-plyr::ldply(raw_data_list,rbind)
  
  # write the results to .CSV file
  write_csv(raw_data_XX,CSV_outfile)   
  
  rm(raw_data_XX)  
  
     
  } # end of 'seq_along(site_names)'
  
 
# *************************************************************


```


\blandscape
```{r stats-part-1, echo = FALSE,include = TRUE, message=FALSE, warning=FALSE, results = 'asis',fig.width=14,fig.height=10}

  # unused chunk option for figures

    # out.width='.89\\linewidth'



# keep the following line; but not sure if it works
# cat("\\newpage")


  # read a single .CSV file; generate basic summary stastics

    # the name of the CSV file
    csv_name<-list.files('data_out/MASTER_CSV_5_min')
  
      # specify the CSV directory location and path to read the CSV file
      CSV_folder<-'data_out/MASTER_CSV_5_min'
      CSV_infile<-file.path(CSV_folder, csv_name)
      
      # create site name prefix
      site_prefix<-strtrim(csv_name,3)
      # print(site_prefix)
      
      # create directory to save statistics results - 5 minute data
      stats_folder_1<-'data_out/Stats_Summary_1'
      
      # create (if necessary) directory - ** first part
      if(dir.exists(stats_folder_1) == FALSE) dir.create(stats_folder_1)
      
      # create directory to save statistics results
      stats_folder_2<-'data_out/Stats_Summary_2'
      
      # create (if necessary) directory - ** first part
      if(dir.exists(stats_folder_2) == FALSE) dir.create(stats_folder_2)
      
       # create directory to save statistics results
      stats_folder_3<-'data_out/Stats_Summary_3'
      
      # create (if necessary) directory - ** first part
      if(dir.exists(stats_folder_3) == FALSE) dir.create(stats_folder_3)
      
      
      # read the rainfall data for one site using 'read_csv'
      rain_5_min<-read_csv(CSV_infile,col_names = TRUE)
      
      # 5 minute rainfall statistics - ** not used but keep for now **
      
      # stats_5_min <- rain_5_min %>% summarize(mean=mean(Rainfall),
      #                                            sd=sd(Rainfall),
      #                                            min=min(Rainfall),
      #                                            Q1=quantile(Rainfall,probs=0.25),
      #                                            median=median(Rainfall),
      #                                            Q3=quantile(Rainfall,probs=0.75),
      #                                            max=max(Rainfall),
      #                                            CV_pct=(sd/mean)*100,
      #                                            total.count=n(),
      #                                            n.valid=sum(!is.na(Rainfall)),
      #                                            pct.valid=(n.valid/total.count)*100)
      # 
      
      # get basic stats on the 5 minute rainfall data
      
      site.name <- rain_5_min$Site.Name[1]
      
      mean <- mean(rain_5_min$Rainfall,na.rm = TRUE)
      
      sd <- sd(rain_5_min$Rainfall,na.rm = TRUE)
      
      max <- max(rain_5_min$Rainfall,na.rm = TRUE)
      
      n.total <- nrow(rain_5_min)
      
      n.NA <- sum(is.na(rain_5_min$Rainfall))
      
      pct.missing <- (n.NA/n.total)*100
      
      n.non.zero <- nrow(subset(rain_5_min,Rainfall > 0))
      
      pct.non.zero <- (n.non.zero/n.total)*100
      
      n.May.to.Sept <- rain_5_min %>% filter(Month >= 5 & Month <= 9)
      
      n.May.to.Sept <- nrow(n.May.to.Sept)
      
      pct.May.to.Sept <- (n.May.to.Sept/n.total)*100
      
      # rbind the results
      
      # stats_5_min <- rbind(mean,sd,max,n.total,n.NA,pct.missing,n.non.zero,pct.non.zero,n.May.to.Sept,pct.May.to.Sept)
      
      stats_5_min_df <- data.frame("Site.Name"=site.name,
                                    "mean"=mean,
                                    "std.dev"=sd,
                                    "max"=max,
                                    "n.total"=n.total,
                                    "n.NA"=n.NA,
                                    "pct.missing"=pct.missing,
                                    "n.non.zero"=n.non.zero,
                                    "pct.non.zero"=pct.non.zero,
                                    "n.May.to.Sept"=n.May.to.Sept,
                                    "pct.May.to.Sept"=pct.May.to.Sept)  
      
     
      # create table #1 using kable
      table_caption<-paste0(site_prefix,' Rainfall Statistics: 5 minute Data')
     
        
      # apply 'knitr::kable' and 'kableExtra' with bold format for the header
      table_1 <- stats_5_min_df %>% knitr::kable(caption = table_caption, digits = 3) %>% kableExtra::row_spec(0,bold = TRUE) %>% kableExtra::kable_styling(latex_options = "scale_down")
      
      # print the result so it shows up in the PDF output
      print(table_1)
    
        
    
      # filter for the May to September rainfall
      rain_5_min_may_sept <- rain_5_min %>% filter(Month >= 5 & Month <= 9)
     
      # get the hourly rainfall
      # Note: you have to add 'ungroup()' before the select command to extract only the hourly.rainfall *** 
     
       rain_hourly <- rain_5_min_may_sept %>% group_by(Year,Month,Day,Hour) %>% summarize(summary.rainfall=sum(Rainfall)) %>% ungroup() %>% select(summary.rainfall)
      
      # get the daily rainfall
      rain_daily <- rain_5_min_may_sept %>% group_by(Year,Month,Day) %>% summarize(summary.rainfall=sum(Rainfall)) %>% ungroup() %>% select(summary.rainfall)
      
      # get the weekly rainfall
      rain_weekly <- rain_5_min_may_sept %>% group_by(Year,Month,Week) %>% summarize(summary.rainfall=sum(Rainfall)) %>% ungroup() %>% select(summary.rainfall)
      
       # get the monthly rainfall
      rain_monthly <- rain_5_min_may_sept %>% group_by(Year,Month) %>% summarize(summary.rainfall=sum(Rainfall)) %>% ungroup() %>% select(summary.rainfall)
      
       # get the yearly rainfall
      rain_yearly<- rain_5_min_may_sept %>% group_by(Year) %>% summarize(summary.rainfall=sum(Rainfall)) %>% ungroup() %>% select(summary.rainfall)
      
      # create a list of the rain interval results
     
      rain_list_1 <- list(rain_hourly,rain_daily,rain_weekly,rain_monthly,rain_yearly)
      
      # use 'map' to convert the list of tibbles to a list of dataframes
       
      rain_list_1 <- rain_list_1 %>% map(as.data.frame)
      
      # use 'map' instead of seq_along 'rain_list_1' to apply 'smry' to the list of dataframes
      
      stats_df_list <- rain_list_1 %>% map(hydroTSM::smry)
       
      # use 'bind_cols' to combine the list of dataframes to one dataframe
      
      stats_df_bind_cols <- bind_cols(stats_df_list)
      
      # add column names
      colnames(stats_df_bind_cols) <- c("Hourly","Daily","Weekly","Monthly","Yearly")
      
      # add Site.Name to the dataframe - this may be optional - under review
      
      Site.Name <- rep(site_prefix,nrow(stats_df_bind_cols))
      
      stats_df_bind_cols<- data.frame(Site.Name,stats_df_bind_cols)
      
      # view(stats_df_bind_cols)
      
      # create a file name to save the files for each site
      CSV_file_name<-paste0(site_prefix,"_stats_summary_hourly_to_yearly.csv")
      CSV_outfile<-file.path(stats_folder_1, CSV_file_name)
        
       # write the results to .CSV file
       write.table(stats_df_bind_cols,CSV_outfile,sep=",",col.names=NA,row.names=TRUE)
      
     
        # create table #2 using kable
  
      table_caption<-paste0(site_prefix,' Rainfall Statistics: Hourly to Yearly [Filter: May to September]')
     
      # Note the use of the print command; this forces the output to come before the chart
      
      # apply 'knitr::kable' and 'kableExtra' with header, row, and column specs
      
       table_2 <- stats_df_bind_cols %>% knitr::kable(caption = table_caption, digits = 3) %>% 
         kableExtra::row_spec(0,bold = TRUE) %>% kableExtra::column_spec(1,width = "3cm") %>% 
          kableExtra::column_spec(2:7,width = "2.2cm")
      
      # print the result so it shows up in the PDF output
      print(table_2)
      
      # find the date-time of the maximum hourly / daily / weekly / monthly / yearly rainfall
      
      # get the hourly / daily / weekly / monthly / yearly rainfall
      
      rain_hourly <- rain_5_min_may_sept %>% group_by(Year,Month,Week,Day,Hour) %>% summarize(Rainfall.mm=sum(Rainfall))
     
      rain_daily <- rain_5_min_may_sept %>% group_by(Year,Month,Week,Day) %>% summarize(Rainfall.mm=sum(Rainfall))
      
      rain_weekly <- rain_5_min_may_sept %>% group_by(Year,Month,Week) %>% summarize(Rainfall.mm=sum(Rainfall))
      
      rain_monthly <- rain_5_min_may_sept %>% group_by(Year,Month) %>% summarize(Rainfall.mm=sum(Rainfall))
      
      rain_yearly <- rain_5_min_may_sept %>% group_by(Year) %>% summarize(Rainfall.mm=sum(Rainfall))
      
      # view(rain_yearly)
      
      # function: identify the maximum event
      
      identify_max <- function(x) {
        max_event <- which(x$Rainfall.mm == max(x$Rainfall.mm))
        return(x[max_event,])
      }
      
      
      # create a list of the rain interval results; ** ungrouped this time **
     
      rain_list_2 <- list(rain_hourly,rain_daily,rain_weekly,rain_monthly,rain_yearly)
      
      # use 'map' to convert the list of tibbles to a list of dataframes
       
      rain_list_2 <- rain_list_2 %>% map(as.data.frame)
      
      # use 'map' instead of seq_along 'rain_list_2' to apply 'identify_max' funcion to the list of dataframes
      
      max_event_df_list <- rain_list_2 %>% map(identify_max)
       
      # use 'bind_rows' to combine the list of dataframes to one dataframe
      
      max_events_df <- bind_rows(max_event_df_list)
      
      # add Site.Name to the dataframe - this may be optional - under review
      
      Site.Name <- rep(site_prefix,nrow(max_events_df))
      
      max_events_df<- data.frame(Site.Name,max_events_df)
      
      # add row names
      
      rownames(max_events_df) <- c("Hourly","Daily","Weekly","Monthly","Yearly")
      
      # view(max_events_df)
      
      
      # create table #3 using kable
      table_caption<-paste0(site_prefix,' Date-Time of Maximum Rainfall - Hourly to Yearly Duration')
     
      # apply 'knitr::kable' and 'kableExtra' with bold format for the header
      
      # table_3 <- max_events_df %>% knitr::kable(caption = table_caption, digits = 3) %>% kableExtra::row_spec(0,bold = TRUE) %>% kableExtra::kable_styling(latex_options = "scale_down")
      
      table_3 <- max_events_df %>% knitr::kable(caption = table_caption, digits = 3) %>% kableExtra::row_spec(0,bold = TRUE) 
     
      # print the result so it shows up in the PDF output
      print(table_3)
     
  
``` 
\elandscape


\blandscape
\newpage

```{r charts-part-1, echo = FALSE,include = TRUE, message=FALSE, warning=FALSE, results = 'asis',fig.width=9,fig.asp=0.618,fig.align='centre'}


# fig.width=14,fig.height=10

      # get the yearly 5-minute data count for the bar chart (ggplot)
       yearly_data_count <- rain_5_min %>% group_by(Year) %>% summarize(n=n())
       
      # create bar chart of the 5 minute data count; one site
      
      # create chart title (dynamic)
      chart_title<-paste0("Rain Gauge"," ",site_prefix," ", "Total 5-Minute Rainfall Data Count")
     
      # create chart PNG outile name (dynamic)
      outfile_name<-paste0(site_prefix," - ", "n_total_5_minute_data_count.png")
      
      # specify directory name
      PNG_folder_name<-stats_folder_3
      
      # change the year from numeric to factor
    p1<-ggplot(data=yearly_data_count, aes(x = factor(Year),y = n,fill=Year)) +
        geom_bar(stat = "identity",position=position_dodge()) +
        theme(axis.title.x = element_text(size = 12),axis.text.x = element_text(angle=45,hjust=1)) +
        theme(axis.title.y = element_text(size = 12)) +
        ylab("Data Count") +
        # note: following requires library(scales)
        scale_y_continuous(labels=comma) +
        xlab("") +
        guides(fill=FALSE) +
      
        theme(plot.margin = unit(c(1,1,1,1), "cm")) +
      
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 12)) +
        ggtitle(chart_title)
      outfile<-file.path(PNG_folder_name,outfile_name)
      ggsave(outfile,p1,width= 6, height=3.708, dpi=600,units=c("in"))
      # print(p1)
    rm(chart_title,outfile_name,PNG_folder_name,outfile) #outfile variable is used again later
  
   
    # plot May - Sept 'annual' rainfall data - plot in descending order
  
  # create chart title (dynamic)
  chart_title<-paste0("Rain Gauge"," ",site_prefix," ", "Total May-Sept. Rainfall - Descending")
  
  # create chart PNG outifle name (dynamic)
  outfile_name<-paste0(site_prefix," - ", "May - Sept Rainfall - Desc.png")
  
   # specify directory name
    PNG_folder_name<-stats_folder_3
  
  p2<-ggplot(data=rain_yearly, aes(x = reorder(Year, -Rainfall.mm),y=Rainfall.mm,fill=Year)) +
    geom_bar(stat = "identity",position=position_dodge()) +
    theme(axis.title.x = element_text(size = 12),axis.text.x = element_text(angle=45,hjust=1)) +
    theme(axis.title.y = element_text(size = 12)) +
    ylab("Rainfall (mm)") +
    scale_y_continuous(limits = c(0,500)) +
    xlab("") +
    guides(fill=FALSE) +
    
    theme(plot.margin = unit(c(1,1,1,1), "cm")) +
   
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.title = element_text(size = 12)) +
    ggtitle(chart_title)
  outfile<-file.path(PNG_folder_name,outfile_name)
  # ggsave(outfile,p2,width= 6, height=3.708, dpi=600,units=c("in"))
  # print(p2)
  rm(chart_title,outfile_name,PNG_folder_name,outfile) #outfile variable is used again later
  
  
  # use 'plot-grid' from cowplot package to to plot p1, p2 stacked one over the other
  
   plot_grid(p1,p2,nrow=2) %>% print()
   

```
\elandscape

\blandscape

```{r charts-part-2, echo = FALSE,include = TRUE, message=FALSE, warning=FALSE, results = 'asis',fig.width=9,fig.asp=0.618,fig.align='centre'}


    # create histogram of hourly rainfall data (cut off = 1 mm)
      
    # filter for hourly events greater than 1 mm

    rain_hourly_GT_1 <- rain_hourly %>% filter(Rainfall.mm > 1)

      # create chart title (dynamic)
      chart_title<-paste0("Rain Gauge"," ",site_prefix," ", "Hourly Rainfall Frequency (> 1 mm)")
    
    p3<-ggplot(data=rain_hourly_GT_1, aes(x = Rainfall.mm)) +
        geom_histogram(binwidth=0.5, colour="black", fill="3366FF") +
        theme(axis.title.x = element_text(size = 12),axis.text.x = element_text(angle=45,hjust=1)) +
        theme(axis.title.y = element_text(size = 12)) +
        ylab("Count") +
        # scale_y_continuous(limits = c(0,500)) +
        xlab("Rainfall.mm") +
        guides(fill=FALSE) +
        theme(plot.margin = unit(c(1,1,1,1), "cm")) +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 12)) +
        ggtitle(chart_title)
      # outfile<-file.path(PNG_folder_name,outfile_name)
      # ggsave(outfile,p3,width= 6, height=3.708, dpi=600,units=c("in"))
      # print(p3)
    
    
     # create histogram for daily rainfall events
      
    # filter for events greater than 5 mm

    rain_daily_GT_2 <- rain_daily %>% filter(Rainfall.mm > 5)

      # create chart title (dynamic)
      chart_title<-paste0("Rain Gauge"," ",site_prefix," ", "Daily Rainfall Frequency (> 5 mm)")
    
       p4<-ggplot(data=rain_daily_GT_2, aes(x = Rainfall.mm)) +
        geom_histogram(binwidth=0.5, colour="black", fill="99CC66") +
        theme(axis.title.x = element_text(size = 12),axis.text.x = element_text(angle=45,hjust=1)) +
        theme(axis.title.y = element_text(size = 12)) +
        ylab("Count") +
        xlab("Rainfall.mm") +
        # guides(fill=FALSE) +
        theme(plot.margin = unit(c(1,1,1,1), "cm")) +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 12)) +
        ggtitle(chart_title)
      # outfile<-file.path(PNG_folder_name,outfile_name)
      # ggsave(outfile,p4,width= 6, height=3.708, dpi=600,units=c("in"))
      # print(p4)
    
    
     # use 'plot-grid' from cowplot package to to plot p3, p4
  
      plot_grid(p3,p4,nrow=2) %>% print()
    
    
```
\elandscape

\blandscape


```{r charts-part-3,echo = FALSE,message=FALSE, warning=FALSE}

    # purpose: scatterplot of the yearly (i.e. May to Sept.) City of Calgary rain gauge rainfall versus the YYC International Airport yearly rainfall 
    
    # the 'rain_yearly' tibble for the City site was originally created on line 385 of chunk 3
    
    # rename the 2nd column in the tibble ('Rainfall.mm') to generic names for easier plotting ''Rainfall.mmCity'

    colnames(rain_yearly) <- c("Year","Rainfall.mm.City.gauge")

    # import the YYC 'annual' rainfall data; the annual YYC rainfall data was compiled in my '3600_weathercan_YYC' project folder
    
    # the YYC 'annual' rainfall data is based on combining Environment Canada data from YYC_2205 and YYC_50430
   
    # specify the CSV directory location and path to read the CSV file
    CSV_folder<-'./Calgary_Intl'
    CSV_infile<-file.path(CSV_folder,'YYC_annual_NA_LTE10.csv')
    
    # read the compiled YYC data into a dataframe
    rain_yearly_YYC<-read.table(CSV_infile,sep=",",header=TRUE,stringsAsFactors = FALSE)
    
    # rename the colnames in 'rain_yearly_YYC' to allow for easier join and scatterplot
    colnames(rain_yearly_YYC) <- c("Year","Rainfall.mm.YYC","NA")
    
    # view(rain_yearly_YYC)
    
    # left join the City data with the YYC data, keeping the rows in the City data
    
    join_City_and_YYC<-left_join(rain_yearly,rain_yearly_YYC,by="Year")
     
    # create scatterplot of City versus YYC yearly rainfall data
    
  ## Note: DO NOT MESS MUCH WITH THE FOLLOWING CODE FOR the p5 plot. It took a while to get it looking right. 
    
      # create chart title (dynamic)
      chart_title<-paste0("Rain Gauge"," ",site_prefix," ", "May to Sept. Yearly Rainfall versus YYC Intl.")
      
      p6<-ggplot() +
      geom_point(data = join_City_and_YYC, shape=19, size=3,colour="blue",aes(x = Rainfall.mm.YYC,y = Rainfall.mm.City.gauge)) + 
        geom_abline(linetype = "dashed",size=1.5,intercept = 0,slope = 1) +
        scale_x_continuous(limits = c(0,500)) +
        scale_y_continuous(limits = c(0,500)) +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 12)) +
      ggtitle(chart_title)
      print(p6)
      

```
\elandscape

```{r duration_analysis-part-1,echo = FALSE,message=FALSE, warning=FALSE}

# this code was copied from 'duration_analysis_1.R' file (project: 3900_CITY_WIDE_RAINFALL_MIT_PART_2)
# the read function was removed becuase the 5-minute rainfall data was already read in a previous chunk


    # filter for specific years ** Optional - During Code Testing **
    # rain_data<- rain_data %>% filter(Year==2007 | Year ==2008)
    
    # filter for months May to September
    rain_5_min<- rain_5_min %>% filter(Month >= 5 & Month <= 9)

    # convert to dataframe
    rain_5_min <- as.data.frame(rain_5_min)
   
    print(head(rain_5_min))


      # specify the MIT values
      MIT_value<-c(60)
    
    # enter loop with the MIT value; get RainEvents that correspond to the MIT_value
    
    for (i in seq_along(MIT_value)) {
      
      print(MIT_value)
    
    
      ## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
      # following code is from Stack Overflow
      ## >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
      
      Rain_Over_0<- rain_5_min[rain_5_min[,"Rainfall"]!=0,]
      
      Rainindex<-c(0,cumsum(diff(Rain_Over_0[,"Date.Time"])>MIT_value[i])) # input your value of MIT (in minutes) where the code says 30.
      
      # Split into list of events
      # this returns a list of events. You can then use sapply functions to determine the rain statistics you need. 
      
      RainEvents_list_1<-split(Rain_Over_0, Rainindex)
      
      #print(str(RainEvents_list_1))
      
     
      ## Sequence along the RainEvents_list_1 list; identify the start and stop date.time for each rainfall event
      # and the duration of each event
      
      # create empty list
      
      RainEvents_list_2<-list(NULL)
      
      for (j in seq_along(RainEvents_list_1)) {
      
      length_date_times<-length(RainEvents_list_1[[j]]$Date.Time)
      first_dt<-RainEvents_list_1[[j]]$Date.Time[1]
      last_dt<-RainEvents_list_1[[j]]$Date.Time[length_date_times]
      
      # print(class(first_dt))
      
      
      
      # filter 'rain_5_min' from first_dt to last_dt
       
      temp_data<- rain_5_min %>% filter(Date.Time >= first_dt & Date.Time <= last_dt)
      
      # add the rainfall event .id; this is just the individual element number of the RainEvents list, but ...
      # you have to subtract 1 so that the id's start at 0, not 1
      
      ID<-j-1  # notice you need to subtract 1, to force the rainfall event id's to start at zero
     
      # mutate to add the rainfall .id to 'temp_data'
      temp_data<- temp_data %>% mutate(.id = ID)
      
      # move the .id column to the front of the dataframe
      temp_data<- temp_data %>% select(.id,everything())
      
      # create a list of the rainfall events - full
      
      RainEvents_list_2[j]<-list(temp_data)
     
   
  }     # end of 'seq_along(RainEvents_list_1)'
  
      
      # function to calculate the cumsum rainfall for each event
      
      rain_cumsum_3<-function(x) {
        
        # cumulative rainfall for each event
        cumulative.rainfall<-cumsum(x$Rainfall)    
        
        # add the cumulative rainfall for each individial event to the list (dataframe) using cbind
        cbind(x,cumulative.rainfall)
        
      }
      
      # function to calculate the cumulative time for each event
      
      time_cumsum_3<-function(x) {
        
        # incremental time difference
        time.diff<-diff(x$Date.Time)
        
        # the first time difference is specified manually as equal to 5 minutes; to get the right total duration
        time.diff<-c(5,time.diff)
        
        # cumulative time difference for each rainfall event
        event.duration.minutes<-cumsum(time.diff)    
        
        # add the cumulative rainfall for each individial event to the list (dataframe) using cbind
        cbind(x,event.duration.minutes)
        
      }
      
      # add the the cumulative time for each event in 'RainEvents_list_2'
      
      RainEvents_list_2<-lapply(RainEvents_list_2,function(x) time_cumsum_3(x))
      
      # add the cumsum rainfall for each event in 'RainEvents_list_2'
      
      RainEvents_list_2<-lapply(RainEvents_list_2,function(x) rain_cumsum_3(x))
      
      
      
  }     # end of 'seq_along(MIT_value)'
      
      
      ## detertime the gap time between rainfall events
      
      # create empty df
      
      gap_times_df <- NULL
      
      # start 'seq_along(RainEvents_list_2)'
      
      for (m in seq_along(RainEvents_list_2)) {
        
        if (m > 1) {
          
          gap_start <- max(RainEvents_list_2[[m-1]]$Date.Time)
          
          gap_end <- min(RainEvents_list_2[[m]]$Date.Time)
          
          gap_duration <- gap_end - gap_start
          
          gap_times_df <- rbind(gap_times_df,gap_duration)
          
          
        }
        
        
      } # end of 'seq_along(RainEvents_list_2)'
      
      # convert gap_times_df to dataframe
        
      gap_times_df <- as.data.frame(gap_times_df)
      
      # print(class(gap_times_df))
      # 
      # print(dim(gap_times_df))
        
      colnames(gap_times_df) <- c("Gap.Time.hours")
      
      # print(head(gap_times_df))
      
      # create directory to save the results
      stats_folder_4<-'data_out/Stats_Summary_4'
      
      # create (if necessary) directory - ** first part
      if(dir.exists(stats_folder_4) == FALSE) dir.create(stats_folder_4)      
      
      # create a file name to save the files for each site
      CSV_file_name<-paste0(site_prefix,"_Gap_Times_All","_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(stats_folder_4, CSV_file_name)
      
      # write the results to .CSV file
      write.table(gap_times_df,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)  
      
      
      # summary statistics on the gap times
      smry_gap_times<- hydroTSM::smry(gap_times_df)
      
      # print(smry_gap_times)
      
      # create a file name to save the file for each site
      CSV_file_name<-paste0(site_prefix,"_Stats_Gap Times","_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(stats_folder_4, CSV_file_name)
      
      # write the results to .CSV file ** note use of 'col.names=NA' to get correct placement of column names
      write.table(smry_gap_times,CSV_outfile,sep=",",col.names=NA,row.names=TRUE)  
      
       
      
      # convert the 'RainEvents_list_2' list to a dataframe using ldply from 'plyr' package
      
      RainEvents_df_long<-plyr::ldply(RainEvents_list_2,rbind)
      
      
      # add the rainfall duration - in hours - for each event
      
      RainEvents_df_long<- RainEvents_df_long %>% mutate(event.duration.hours=(event.duration.minutes/60))
      
      # add the cumulative rainfall intensity (mm/hr) for each event
      
      RainEvents_df_long<- RainEvents_df_long %>% mutate(event.rainrate.mm.hr=cumulative.rainfall/event.duration.hours)
      
      # add the rainfall intensity (mm/hr) for each 5 minute time step
      
      RainEvents_df_long<- RainEvents_df_long %>% mutate(intensity.mm.hr=Rainfall/(5/60))
      
      
      # add a new field 'Site.Name.id' to allow working with 60/240/1440 event data from all the sites
      
      Site.Name.id<-paste0(RainEvents_df_long$Site.Name,"-",RainEvents_df_long$.id)
      RainEvents_df_long<-cbind(Site.Name.id,RainEvents_df_long)
      
      #print(head(RainEvents_df_long))
      
     
      
      
      # create a file name to save the files for each site
      CSV_file_name<-paste0(site_prefix,"_Rain_Events_All","_MIT_",MIT_value,".csv")
      #CSV_outfile<-file.path(out_folder_events_full, CSV_file_name)
      CSV_outfile<-file.path(stats_folder_4, CSV_file_name)
      
      # write the results to .CSV file
      write.table(RainEvents_df_long,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)  
      
      
      # summary statistics - all rain events
      
      # summarize based on the last line of each event, which has the total cumulative.rainfall, duration, and rainfall intensity
      
      last_line_df<- RainEvents_df_long %>% group_by(.id) %>% summarize(depth=last(cumulative.rainfall), duration.minutes=last(event.duration.minutes),duration.hours=last(event.duration.hours),rainrate.mm.hr=last(event.rainrate.mm.hr),max.intensity.mm.hr=max(intensity.mm.hr,na.rm=TRUE))
      
      # create a file name to save the file for each site
      # CSV_file_name<-paste0(site_prefix,"_Duration_",duration_value[i],"_Rain_Events_Last_Line","_MIT_",MIT_value,".csv")
      # CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file ** OPTIONAL **
      # write.table(last_line_df,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)
      
      
      # SECTION: rainfall summary stats
      
      # number of discrete rainfall events
      num_rain_events<-nrow(last_line_df)
      
      # summary - rainfall depth
      summary_depth<-summary(last_line_df$depth)
      summary_1<-c(num_rain_events,summary_depth)
      
      # summary - rainfall duration (hours)
      summary_hours<-summary(last_line_df$duration.hours)
      summary_2<-c(num_rain_events,summary_hours)
      
      # summary - final rainfall rain rate (mm/hr)
      summary_rainrate<-summary(last_line_df$rainrate.mm.hr)
      summary_3<-c(num_rain_events,summary_rainrate)
      
      
      # summary - maximum rainfall rain rate (mm/hr)
      summary_max_rainrate<-summary(last_line_df$max.intensity.mm.hr)
      summary_4<-c(num_rain_events,summary_max_rainrate)
      
      # combine summary statistics
      combined_summary<-as.data.frame(cbind(summary_1,summary_2,summary_3,summary_4))
      
      rownames(combined_summary)<-c("Number of Events","Min","1st Quartile","Median","Mean","3rd Quartile","Max")
      names(combined_summary)<-c("Depth (mm)","Duration (hours)","Final Rainrate (mm/hr)","Maximum Rainrate (mm/hr)")
      
      # create a file name to save the file for each site
      CSV_file_name<-paste0(site_prefix,"_Stats_Summary_All_Events","_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(stats_folder_4, CSV_file_name)
      
      # write the results to .CSV file ** note use of 'col.names=NA' to get correct placement of column names
      write.table(combined_summary,CSV_outfile,sep=",",col.names=NA,row.names=TRUE)  
      
      
      
      
      
     
      ## the code that follows is selectively executed, only if you want the stats and charts saved for each site
      ## turning this off speeds up the city-wide processing
      
      # create a flag value
      site_by_site<-0
      
      if (site_by_site==1) {
        
        # create (dynamically) directories to save results for each rain gauge site
        # create directory name and directory - ** first part **
        out_folder_dynamic<-paste0(out_folder,"/",site_prefix,"_Results")
        
        # create (if necessary) directory
        if(dir.exists(out_folder_dynamic) == FALSE) dir.create(out_folder_dynamic)
        
        
      # create a file name to save the files for each site
      CSV_file_name<-paste0(site_prefix,"_Rain_Events_All","_MIT_",MIT_value,".csv")
      #CSV_outfile<-file.path(out_folder_events_full, CSV_file_name)
      CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file
      write.table(RainEvents_df_long,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)  
    
   
      # summary statistics - all rain events
      
      # summarize based on the last line of each event, which has the total cumulative.rainfall, duration, and rainfall intensity
      
      last_line_df<- RainEvents_df_long %>% group_by(.id) %>% summarize(depth=last(cumulative.rainfall), duration.minutes=last(event.duration.minutes),duration.hours=last(event.duration.hours),rainrate.mm.hr=last(event.rainrate.mm.hr),max.intensity.mm.hr=max(intensity.mm.hr,na.rm=TRUE))
      
      # create a file name to save the file for each site
      # CSV_file_name<-paste0(site_prefix,"_Duration_",duration_value[i],"_Rain_Events_Last_Line","_MIT_",MIT_value,".csv")
      # CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file ** OPTIONAL **
      # write.table(last_line_df,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)
   
      
      # SECTION: rainfall summary stats
      
      # number of discrete rainfall events
      num_rain_events<-nrow(last_line_df)
      
      # summary - rainfall depth
      summary_depth<-summary(last_line_df$depth)
      summary_1<-c(num_rain_events,summary_depth)
      
      # summary - rainfall duration (hours)
      summary_hours<-summary(last_line_df$duration.hours)
      summary_2<-c(num_rain_events,summary_hours)
      
      # summary - final rainfall rain rate (mm/hr)
      summary_rainrate<-summary(last_line_df$rainrate.mm.hr)
      summary_3<-c(num_rain_events,summary_rainrate)
      
      
      # summary - maximum rainfall rain rate (mm/hr)
      summary_max_rainrate<-summary(last_line_df$max.intensity.mm.hr)
      summary_4<-c(num_rain_events,summary_max_rainrate)
      
      # combine summary statistics
      combined_summary<-as.data.frame(cbind(summary_1,summary_2,summary_3,summary_4))
      
      rownames(combined_summary)<-c("Number of Events","Min","1st Quartile","Median","Mean","3rd Quartile","Max")
      names(combined_summary)<-c("Depth (mm)","Duration (hours)","Final Rainrate (mm/hr)","Maximum Rainrate (mm/hr)")
      
      # create a file name to save the file for each site
      CSV_file_name<-paste0(site_prefix,"_Stats_Summary_All_Events","_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file ** OPTIONAL **
      write.table(combined_summary,CSV_outfile,sep=",",col.names=TRUE,row.names=TRUE)  
      
      
      
      # SECTION: rainfall summary stats (specific durations)
     

      # create a file name to save the duration-specific rain events for each site
      CSV_file_name<-paste0(site_prefix,"_Rain_Events_Duration_",duration_value[i],"_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file
      write.table(RainEvents_TEMP,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)
      
      
      # summarize according to the last line of each event, which has the total cumulative.rainfall, duration, and rainfall intensity
      
      last_line_df<- RainEvents_by_duration %>% group_by(.id) %>% summarize(depth=last(cumulative.rainfall), duration.minutes=last(event.duration.minutes),duration.hours=last(event.duration.hours),rainrate.mm.hr=last(event.rainrate.mm.hr),max.intensity.mm.hr=max(intensity.mm.hr,na.rm=TRUE))
        

      
      # SECTION: rainfall summary stats - specific durations
      
      # number of discrete rainfall events
      num_rain_events<-nrow(last_line_df)
      
      # summary - rainfall depth
      summary_depth<-summary(last_line_df$depth)
      summary_1<-c(num_rain_events,summary_depth)
      
      # summary - rainfall duration (hours)
      summary_hours<-summary(last_line_df$duration.hours)
      summary_2<-c(num_rain_events,summary_hours)
      
      # summary - final rainfall rain rate (mm/hr)
      summary_rainrate<-summary(last_line_df$rainrate.mm.hr)
      summary_3<-c(num_rain_events,summary_rainrate)
      
      
      # summary - maximum rainfall rain rate (mm/hr)
      summary_max_rainrate<-summary(last_line_df$max.intensity.mm.hr)
      summary_4<-c(num_rain_events,summary_max_rainrate)
      
      # combine summary statistics
      combined_summary<-as.data.frame(cbind(summary_1,summary_2,summary_3,summary_4))
      
      rownames(combined_summary)<-c("Number of Events","Min","1st Quartile","Median","Mean","3rd Quartile","Max")
      names(combined_summary)<-c("Depth (mm)","Duration (hours)","Final Rainrate (mm/hr)","Maximum Rainrate (mm/hr)")
      
      # create a file name to save the file for each site
      CSV_file_name<-paste0(site_prefix,"_Stats_Summary_Duration_",duration_value[i],"_MIT_",MIT_value,".csv")
      CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file ** OPTIONAL **
      write.table(combined_summary,CSV_outfile,sep=",",col.names=TRUE,row.names=TRUE)
      
      
      
      
      # SECTION: plot line charts
      
      # group by .id and summarize by the maximum event duration in minutes: filter for events matching plus or minus 10% of 'duration_value'
      
      shorter_duration<-0.9*duration_value[i]
      longer_duration<-1.1*duration_value[i]
      
      event_IDs_by_duration<- RainEvents_df_long %>% group_by(.id) %>% summarize(max.event.duration=max(event.duration.minutes,na.rm=TRUE),na.rm=TRUE) %>% filter(max.event.duration >= shorter_duration & max.event.duration <= longer_duration)
      
      # select the rainfall events that match the duration of interest
      
      RainEvents_by_duration<- RainEvents_df_long %>% filter(.id %in% event_IDs_by_duration$.id)
      
      # create a file name to save the files for each site ** OPTIONAL **
      CSV_file_name<-paste0(site_prefix,"_Duration_",duration_value[i],"_Events_Plus_Minus_","_MIT_",MIT_value,".csv")
      #CSV_outfile<-file.path(out_folder_events_full, CSV_file_name)
      CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file
      # write.table(RainEvents_by_duration,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)
      
      
      # plot the cumsum rainfall; Top 5 largest events only AND the Chicago Design Storms
      
    
      # select the columns from 'RainEvents_by_duration' to match the 'Chicago_list_df.csv' file  
      RainEvents_by_duration_2<-  RainEvents_by_duration %>% select(.id,Date.Time,Rainfall,cumulative.rainfall,event.duration.minutes)
      
      #print(head(RainEvents_by_duration_2))
      
      # arrange the events by cumulative.rainfall and select the 5 largest events
      
      event_IDs_by_depth<- RainEvents_by_duration_2 %>% group_by(.id) %>% summarize(max.cumulative.rainfall=max(cumulative.rainfall,na.rm=TRUE)) %>% arrange(desc(max.cumulative.rainfall)) %>% slice(1:5)
      
    
      # select the rainfall events that match the duration of interest
      RE_top_5<- RainEvents_by_duration_2 %>% filter(.id %in% event_IDs_by_depth$.id)
      
      # add a column 'Event.Type'
      Event.Type<-'Actual.Event'
      
      RE_top_5<-cbind("Event.Type"=Event.Type,RE_top_5)
      
      # print(str(RE_top_5))
      # print(tail(RE_top_5))
      
      # create an .id for the 1:10 and 1:100 year Chicago storms of interest (dynamic based on duration value)
      Chicago_id_10<-paste0("10yr_",duration_value[i],"min")
      Chicago_id_100<-paste0("100yr_",duration_value[i],"min")
      
      # select the corresponding Chicago design storm data
      Chicago_ds_10<- Chicago_df %>% filter(.id==Chicago_id_10)
      Chicago_ds_100<- Chicago_df %>% filter(.id==Chicago_id_100)
    
      # add a column 'Event.Type' to the Chicago design storm data (* to faciliate ggplot plotting *)
      
      Chicago_ds_10<-cbind("Event.Type"='Chicago.10.Year',Chicago_ds_10)
      Chicago_ds_100<-cbind("Event.Type"='Chicago.100.Year',Chicago_ds_100)
      
      # rbind the two design storms dataframes
      Chicago_ds_10_100<-rbind(Chicago_ds_10,Chicago_ds_100)
    
      #print(Chicago_ds_10_100)
      
      # try merging the RainEvents_by_depth and the Chicago design storm
      #RainEvents_by_depth$.id<-as.character(RainEvents_by_depth$.id)
      
      # rbind the design storm data into 'RE_top_5'
      RE_top_5<-rbind(RE_top_5,Chicago_ds_10_100)
      
      # print(str(RE_top_5))
      # print(tail(RE_top_5))
      
      
      # create a file name to save the file for each site ** OPTIONAL **
      # CSV_file_name<-paste0(site_prefix,"_Duration_",duration_value[i],"_RainEvents_by_depth_with_Chicago","_MIT_",MIT_value,".csv")
      # CSV_outfile<-file.path(out_folder_dynamic, CSV_file_name)
      
      # write the results to .CSV file ** OPTIONAL **
      # write.table(RE_top_5,CSV_outfile,sep=",",col.names=TRUE,row.names=FALSE)
      
      # create chart title (dynamic)
      chart_title<-paste0(site_prefix," ",duration_value[i]," +/- 10%: Top 5 versus Chicago DS_","_MIT_",MIT_value)
      
      # create chart PNG outfile (dynamic)
      outfile_name<-paste0(site_prefix," ",duration_value[i],"_Minute Events Top 5 versus Chicago DS_","_MIT_",MIT_value,".png")
      
      
      # Note: in the following ggplot command, note that the event .id was converted to a factor to enable the legend
      
       p1<-ggplot(data=RE_top_5, aes(x=event.duration.minutes,y=cumulative.rainfall,color=Event.Type,group=.id)) +
        geom_line(aes(linetype=Event.Type)) +
        # manually specify the color for each Event.Type  
        scale_color_manual(values=c(Actual.Event="red",Chicago.10.Year="green",Chicago.100.Year="blue")) +
        
        # set a black border  
        theme_bw() +
        theme(panel.border = element_rect(color="black", size=0.5, linetype="solid")) +
        theme(axis.title.x = element_text(size = 10),axis.text.x = element_text(angle=45,hjust=1)) +
        theme(axis.title.y = element_text(size = 10)) +
        ylab("Cumulative Rainfall (mm)") +
        xlab("Event Duration (min.)") +
        theme(legend.title = element_blank()) +
        theme(legend.text = element_text(size = 10)) +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 10)) +
        ggtitle(chart_title)
      outfile<-file.path(out_folder_dynamic,outfile_name)
      ggsave(outfile,p1,width= 6, height=3.708, dpi=600,units=c("in"))
      rm(p1)
      rm(outfile,chart_title) #outfile variable is used again later
      
      
      
      
      
      
      # plot the cumsum rainfall; All events, AND the Chicago Design Storms
      
      
      # add a column 'Event.Type' to 'RainEvents_by_duration_2'
      Event.Type<-'Actual.Event'
      
      RE_all<-cbind("Event.Type"=Event.Type,RainEvents_by_duration_2)
      
      
      # rbind the design storm data into 'RE_all'
      RE_all<-rbind(RE_all,Chicago_ds_10_100)
      
    
      # create chart title (dynamic)
      chart_title<-paste0(site_prefix," ",duration_value[i]," +/- 10%: All Events versus Chicago DS_","_MIT_",MIT_value)
      
      # create chart PNG outfile (dynamic)
      outfile_name<-paste0(site_prefix," ",duration_value[i],"_Minute Events versus Chicago DS_","_MIT_",MIT_value,".png")
      
      
      # Note: in the following ggplot command, note that the event .id was converted to a factor to enable the legend
      
      p1<-ggplot(data=RE_all, aes(x=event.duration.minutes,y=cumulative.rainfall,color=Event.Type,group=.id)) +
        geom_line(aes(linetype=Event.Type)) +
        # manually specify the color for each Event.Type  
        scale_color_manual(values=c(Actual.Event="red",Chicago.10.Year="green",Chicago.100.Year="blue")) +
        
        # set a black border  
        theme_bw() +
        theme(panel.border = element_rect(color="black", size=0.5, linetype="solid")) +
        
        theme(axis.title.x = element_text(size = 10),axis.text.x = element_text(angle=45,hjust=1)) +
        theme(axis.title.y = element_text(size = 10)) +
        ylab("Cumulative Rainfall (mm)") +
        xlab("Event Duration (min.)") +
        theme(legend.title = element_blank()) +
        theme(legend.text = element_text(size = 10)) +
        theme(plot.title = element_text(hjust = 0.5)) +
        theme(plot.title = element_text(size = 10)) +
        ggtitle(chart_title)
      outfile<-file.path(out_folder_dynamic,outfile_name)
      ggsave(outfile,p1,width= 6, height=3.708, dpi=600,units=c("in"))
      rm(p1)
      rm(outfile,chart_title) #outfile variable is used again later
      
      
      } # end of if(site_by_site ==1) section
      
      
    # }  ## End of 'seq_along duration_value' ##
    
 



```




